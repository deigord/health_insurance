---
title: "health_insurance"
author: "Alexey Gordeev"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(readr)
suppressPackageStartupMessages(library(tidyverse))

library(flextable)

```

# Чтение датасета


```{r data}
insurance <- read_delim("data/raw/HealthInsurance.csv")

#Просмотр датасета

#view(insurance)

#Проверка датасета на наличие отсутствующих данных

#colSums(is.na(insurance))

#Смена типа переменных с character на factor

insurance <- insurance %>% 
  mutate(across(where(is.character), as.factor))

#Переименовывание переменных на русский язык

# insurance <- insurance %>%
#   rename(
#     `Идентификационный номер` = rownames,
#     `Статус здоровья` = health,
#     `Возраст` = age,
#     `Ограничения` = limit,
#     `Пол` = gender,
#     `Медицинская страховка` = insurance,
#     `Семейный статус: замужем / женат` = married,
#     `Самозанятость` = selfemp,
#     `Количество членов семьи` = family,
#     `Регион проживания` = region,
#     `Национальность` = ethnicity,
#     `Образование` = education
#   )

#Присваивание лейблов

#Описательные статистики для категориальнх переменных

#summary(insurance)

output_for_categorical_variables <- insurance %>%
  select(where(is.factor)) %>% #Выбираем только качественные данные
  pivot_longer(cols = everything(), names_to = "variable", values_to = "category") %>%
  group_by(variable, category) %>% #Группируем данные
  summarise(count = n(), .groups = "drop") %>%
  group_by(variable) %>%
  mutate(total = sum(count),
         percentage = round(count / total * 100, 2)) %>%
  #ungroup() %>%
  select(variable, category, count, percentage) %>%
  rename(
    Признак = variable,
    Группа = category,
    `Количество людей` = count,
    `Процент от общего количества` = percentage
  ) %>%
  flextable() %>% 
  merge_v(j=1)

output_for_categorical_variables

#Описательные статистики для количественных переменных
output_for_numerical_variables <- insurance %>%
  select("age", "family") %>% #Выбираем только количественные данные
    summarise(across(everything(), 
                     list(
    mean = ~ round(mean(.x), 2), #Округляем до сотых
    median = ~ median(.x),
    sd = ~ round(sd(.x), 2), #Округляем до сотых
    min = ~ min(.x),
    max = ~ max(.x),
    q1 = ~ quantile(.x, 0.25),
    q3 = ~ quantile(.x, 0.75)
  ), .names = "{col}_{fn}")) %>% #Считаем статистики, выводим их в формате "имя переменной_название статистики"
  pivot_longer(everything(), names_to = "variable_statistics", values_to = "value") %>% #Переводим данные в длинный формат, чтобы затем разделить первый столбик на два отдельных с именем переменной и названием статистики
  separate(variable_statistics, into = c("variable", "statistics"), sep = "_") %>%
  pivot_wider(names_from = statistics, values_from = value) %>% #возвращаем всё в широкий формат, чтобы данные были сгруппированы по имени переменной
  rename(
    `Переменная` = variable,
    `Среднее значение` = mean,
    `Медиана` = median,
    `Стандартное отклонение` = sd,
    `Минимальное значение` = min,
    `Максимальное значение` = max,
    `Квантиль 1` = q1,
    `Квантиль 3` = q3
  )

```