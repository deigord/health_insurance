---
title: "health_insurance"
author: "Alexey Gordeev"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(readr)
suppressPackageStartupMessages(library(tidyverse))
library(patchwork)
```

# Чтение датасета

```{r data}
insurance <- read_delim("data/raw/HealthInsurance.csv")

insurance <- insurance %>% 
  mutate(across(where(is.character), as.factor))
```


# Распределение значений признаков

## Номинативные переменные

```{r, fig.width=7, fig.height=50, dpi=300}

# cat_plots_data <- insurance %>% 
#   mutate(across(where(is.factor), as.character)) %>% 
#   select(rownames, where(is.character)) %>% 
#   pivot_longer(!rownames)

theme_plots <- theme_classic() +
  theme(plot.title = element_text(size = 28, hjust = 0.5),
    plot.subtitle = element_text(size = 25, hjust = 0.5),
    axis.title = element_text(size = 20),
    axis.text.y = element_text(size = 18),
    axis.text.x = element_text(size = 18),
    legend.title = element_text(size = 20),
    legend.text = element_text(size = 18),
    strip.text = element_text(size = 20))
theme_set(theme_plots)

col_list <- insurance %>% select(where(is.factor))

# barplots function
barplot_fn <- function(col) {
  label <- rlang::englue("Barplot of {{col}} variable\nwith proportion")
  insurance %>% 
  ggplot() +
    geom_bar(aes(x = "", fill = {{col}}),
             position = "fill", width = 0.5) +
    labs(title = label,
         y = "Proportion",
         x = rlang::englue("{{col}}")) +
    scale_fill_discrete(name = rlang::englue("{{col}}"))
}

col_list <- insurance %>%
  select(where(is.factor)) %>%
  names() %>%
  syms()

bar_plots <- purrr::map(col_list,
    ~ barplot_fn(!!.x))

wrap_plots(bar_plots, ncol = 1)
```

```{r, fig.width=7, fig.height=40, dpi=300}
# insurance %>%
#   mutate(across(where(is.factor), as.character)) %>%
#   select(rownames, where(is.character)) %>%
#   pivot_longer(!rownames) %>% 
#   ggplot()+
#     geom_bar(aes(x = "", fill = value),
#              position = "fill", width = 0.5) +
#     labs(y = "Proportion") +
#   facet_wrap(~name, ncol = 1)
```


## Количественные переменные

```{r, fig.width=12, fig.height=12, dpi=300}
hist_fn <- function(col, width) {
  
  ggplot(insurance, aes(x = {{col}})) +
  geom_boxplot(
    alpha = 0.5,
    width = width,
    linewidth = 1.5,
    outlier.size = 2
  ) +
  geom_histogram(
    fill = "mediumpurple3",
    alpha = 0.5,
    colour = "black",
    bins = 25
  ) +
  labs(title = rlang::englue("Histogram of the distribution of variable {{col}}\nand boxplot with median and IQR"),
       y = "Quantity",
       x = rlang::englue("{{col}}")) +
  theme(plot.title = element_text(hjust = 0.5),
        axis.title = element_text(size = 25),
        axis.text.y = element_text(size = 23),
        axis.text.x = element_text(size = 23),
        legend.title = element_text(size = 23),
        legend.text = element_text(size = 23))
}

plot1 <- hist_fn(age, 100)
plot2 <- hist_fn(family, 400)

plot1 / plot2
```

